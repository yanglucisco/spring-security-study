<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>index11111页面</title>
    <script>
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('XSRF-TOKEN='))
                ?.split('=')[1];
            return cookieValue;
        }

        // 或者，如果您的后端注销端点必须使用 POST 方法（如CSRF防护），可以创建一个表单并提交
        function logout() {
            // 获取CSRF令牌
            const csrfToken = getCsrfToken()
            console.log('令牌:' + csrfToken)
            const form = document.createElement('form')
            form.method = 'POST';
            form.action = 'http://127.0.0.1:10000/logout'
            // 如果需要，可以添加CSRF令牌等参数
            document.body.appendChild(form)
            form.submit()
        }
        async function postTest() {
            // window.location.href = 'http://127.0.0.1:10000/logout'
            const csrfToken = getCsrfToken('XSRF-TOKEN');
            const a = fetch('http://127.0.0.1:10000/client1/posttest', {
                method: 'POST',
                headers: {
                    'X-XSRF-TOKEN1': csrfToken // 确保这里正确设置了头信息
                },
            })
            console.log(a)
        }
    </script>
</head>

<body>
    <form id="logoutForm" method="post" action="logout">
        <input id="csrf" type="hidden" name="_csrf"
            value="" />
        <input type="submit" value="退出登录" />
    </form>
    <h1>我是index11111111.html</h1>
    <!-- <span>点击后，从后台获取数据，如果未登录，则跳转到收取服务器的登录页面</span> -->
    <!-- <button onclick="postTest()">退出登录csrf</button> -->
    <h1 id="scope">后台要求scope的内容</h1>
    <h1 id="role">后台要求role内容</h1>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 获取要插入数据的容器元素
            const scope = document.getElementById('scope')
            const scopeRes = await fetch('http://127.0.0.1:10000/resourcescope0/test')
            if (scopeRes.status === 401) {
                console.log('401未授权')
                window.open('/oauth2/authorization/gateway?redirect_uri=http://127.0.0.1:10000/index1.html', '_self')
                return
            }
            const scopeData = await scopeRes.text()
            scope.innerHTML = scopeData

            // 获取要插入数据的容器元素
            const role = document.getElementById('role')
            const roleRes = await fetch('http://127.0.0.1:10000/resourcerole0/roleadmin')
            if (roleRes.status === 401) {
                console.log('401未授权')
                window.open('/oauth2/authorization/gateway?redirect_uri=http://127.0.0.1:10000/index1.html', '_self')
                return
            }
            const roleData = await roleRes.text()
            role.innerHTML = roleData
        })
        document.getElementById('logoutForm').addEventListener('submit', function (event) {
            // 阻止表单默认提交行为
            event.preventDefault()
            console.log('用户点击了注销')
            console.log('csrf_token = ' + getCsrfToken())
            document.getElementById('csrf').value = getCsrfToken()
            // 在这里执行你的JS程序
            // var username = this.elements['username'].value // 使用this获取表单元素
            // if (username === '') {
            //     alert('用户名不能为空')
            //     return; // 退出函数，不再执行后续逻辑
            // }
            // 如果验证通过，可以手动提交表单或执行其他操作
            this.submit() // 这会触发表单的同步提交和页面跳转
        })
    </script>
</body>

</html>